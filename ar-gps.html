<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR GPS - Muntanya100</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .arjs-loader div {
            text-align: center;
            font-size: 1.25em;
            color: white;
        }
        #exit-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 10px 15px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            z-index: 9999;
            max-height: 30vh;
            overflow-y: auto;
        }
        /* Añadir botones para ajustar la escala */
        #control-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 9999;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
        .control-button {
            margin: 5px;
            padding: 5px 10px;
            background-color: rgba(255,255,255,0.3);
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <div class="arjs-loader">
        <div>Cargando experiencia AR con GPS, por favor espera...</div>
    </div>
    
    <button id="exit-button" onclick="window.location.href='/Muntanya100/'">❌ Sortir</button>
    
    <div id="control-panel">
        <div>Ajustar marcadores:</div>
        <button class="control-button" onclick="adjustScale(2)">+ Tamaño</button>
        <button class="control-button" onclick="adjustScale(0.5)">- Tamaño</button>
        <button class="control-button" onclick="adjustHeight(500)">+ Altura</button>
        <button class="control-button" onclick="adjustHeight(-500)">- Altura</button>
        <button class="control-button" onclick="toggleVisibility()">Mostrar/Ocultar</button>
        <button class="control-button" onclick="recreateEntities()">Recrear Marcadores</button>
    </div>
    
    <div id="debug-panel">Iniciando AR con GPS...</div>
    
    <a-scene
        embedded
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; gpsMinDistance: 5; gpsTimeInterval: 0;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; antialias: true; precision: mediump;"
        loading-screen="enabled: false">
        
        <a-camera gps-projected-camera="gpsMinDistance: 5; simulateLatitude: 42.0284; simulateLongitude: 2.6166;" rotation-reader>
            <!-- Mensaje de estado -->
            <a-entity 
                text="value: Buscando posición GPS...; color: white; align: center; width: 3;"
                position="0 -0.5 -1"
                id="status-message">
            </a-entity>
            
            <!-- Mensaje de instrucciones -->
            <a-entity 
                text="value: Buscando cims cercanos...; color: yellow; align: center; width: 3;"
                position="0 0.5 -1"
                id="instruction-message">
            </a-entity>
        </a-camera>
    </a-scene>
    
    <script>
        const debugPanel = document.getElementById('debug-panel');
        const loader = document.querySelector('.arjs-loader');
        let currentScale = 1;
        let currentHeight = 0;
        let entitiesVisible = true;
        let cims = [];
        let entitiesCreated = false;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugPanel.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }
        
        // Función para ajustar la escala de todos los marcadores
        function adjustScale(factor) {
            currentScale *= factor;
            log(`Ajustando escala a: ${currentScale.toFixed(2)}`);
            
            document.querySelectorAll('a-sphere').forEach(sphere => {
                const currentRadius = parseFloat(sphere.getAttribute('radius'));
                sphere.setAttribute('radius', currentRadius * factor);
            });
            
            document.querySelectorAll('a-text').forEach(text => {
                const currentScale = text.getAttribute('scale').split(' ').map(parseFloat);
                text.setAttribute('scale', `${currentScale[0] * factor} ${currentScale[1] * factor} ${currentScale[2] * factor}`);
            });
            
            document.querySelectorAll('a-cylinder').forEach(cylinder => {
                const currentRadius = parseFloat(cylinder.getAttribute('radius'));
                const currentHeight = parseFloat(cylinder.getAttribute('height'));
                cylinder.setAttribute('radius', currentRadius * factor);
                cylinder.setAttribute('height', currentHeight * factor);
            });
        }
        
        // Función para ajustar la altura de todos los marcadores
        function adjustHeight(delta) {
            currentHeight += delta;
            log(`Ajustando altura a: ${currentHeight}`);
            
            document.querySelectorAll('a-entity[gps-projected-entity-place]').forEach(entity => {
                const children = entity.children;
                for (let i = 0; i < children.length; i++) {
                    const child = children[i];
                    const currentPosition = child.getAttribute('position').split(' ');
                    const x = parseFloat(currentPosition[0]);
                    const y = parseFloat(currentPosition[1]) + delta;
                    const z = parseFloat(currentPosition[2]);
                    child.setAttribute('position', `${x} ${y} ${z}`);
                }
            });
        }
        
        // Función para mostrar/ocultar marcadores
        function toggleVisibility() {
            entitiesVisible = !entitiesVisible;
            log(`Marcadores ${entitiesVisible ? 'visibles' : 'ocultos'}`);
            
            document.querySelectorAll('a-entity[gps-projected-entity-place]').forEach(entity => {
                entity.setAttribute('visible', entitiesVisible);
            });
        }
        
        // Función para recrear entidades
        function recreateEntities() {
            log('Recreando marcadores...');
            
            // Eliminar entidades existentes
            document.querySelectorAll('a-entity[gps-projected-entity-place]').forEach(entity => {
                entity.parentNode.removeChild(entity);
            });
            
            // Recrear entidades
            createEntities();
        }
        
        // Función para crear entidades
        function createEntities() {
            if (cims.length === 0) {
                log('No hay cims para mostrar');
                return;
            }
            
            log(`Creando ${cims.length} marcadores...`);
            const scene = document.querySelector('a-scene');
            
            // Obtener posición actual
            navigator.geolocation.getCurrentPosition(
                position => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    
                    cims.forEach(cim => {
                        log(`Creando entidad para ${cim.nom} en ${cim.latitude}, ${cim.longitude}`);
                        
                        // Calcular distancia aproximada
                        const R = 6371; // Radio de la Tierra en km
                        const dLat = (cim.latitude - userLat) * Math.PI / 180;
                        const dLon = (cim.longitude - userLon) * Math.PI / 180;
                        const a = 
                            Math.sin(dLat/2) * Math.sin(dLat/2) +
                            Math.cos(userLat * Math.PI / 180) * Math.cos(cim.latitude * Math.PI / 180) * 
                            Math.sin(dLon/2) * Math.sin(dLon/2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                        const distance = R * c;
                        
                        log(`Distancia a ${cim.nom}: ${distance.toFixed(2)} km`);
                        
                        // Crear entidad GPS con el nuevo componente gps-projected-entity-place
                        const entity = document.createElement('a-entity');
                        entity.setAttribute('gps-projected-entity-place', `latitude: ${cim.latitude}; longitude: ${cim.longitude}`);
                        entity.setAttribute('id', `cim-${cim.id}`);
                        entity.setAttribute('scale', '1 1 1');
                        
                        // Añadir marcador grande y brillante
                        const marker = document.createElement('a-sphere');
                        marker.setAttribute('radius', '100'); // Tamaño más grande para mejor visibilidad
                        marker.setAttribute('color', 'red');
                        marker.setAttribute('opacity', '0.8');
                        marker.setAttribute('position', '0 0 0'); // A nivel del suelo
                        marker.setAttribute('emissive', 'red');
                        marker.setAttribute('emissiveIntensity', '0.5');
                        entity.appendChild(marker);
                        
                        // Añadir cilindro para conectar con el texto
                        const cylinder = document.createElement('a-cylinder');
                        cylinder.setAttribute('radius', '40');
                        cylinder.setAttribute('height', '200');
                        cylinder.setAttribute('color', 'yellow');
                        cylinder.setAttribute('opacity', '0.5');
                        cylinder.setAttribute('position', '0 100 0');
                        entity.appendChild(cylinder);
                        
                        // Añadir texto con el nombre
                        const text = document.createElement('a-text');
                        text.setAttribute('value', cim.nom);
                        text.setAttribute('look-at', '[gps-projected-camera]');
                        text.setAttribute('scale', '100 100 100');
                        text.setAttribute('align', 'center');
                        text.setAttribute('color', 'white');
                        text.setAttribute('position', '0 240 0');
                        entity.appendChild(text);
                        
                        // Añadir texto con altitud
                        const altText = document.createElement('a-text');
                        altText.setAttribute('value', `${cim.altitud}m`);
                        altText.setAttribute('look-at', '[gps-projected-camera]');
                        altText.setAttribute('scale', '80 80 80');
                        altText.setAttribute('align', 'center');
                        altText.setAttribute('color', 'yellow');
                        altText.setAttribute('position', '0 200 0');
                        entity.appendChild(altText);
                        
                        // Añadir texto con distancia
                        const distText = document.createElement('a-text');
                        distText.setAttribute('value', `${distance.toFixed(1)} km`);
                        distText.setAttribute('look-at', '[gps-projected-camera]');
                        distText.setAttribute('scale', '80 80 80');
                        distText.setAttribute('align', 'center');
                        distText.setAttribute('color', 'lightgreen');
                        distText.setAttribute('position', '0 160 0');
                        entity.appendChild(distText);
                        
                        scene.appendChild(entity);
                    });
                    
                    entitiesCreated = true;
                    
                    // Actualizar mensaje de instrucciones
                    const instructionEl = document.getElementById('instruction-message');
                    if (instructionEl) {
                        instructionEl.setAttribute(
                            'text',
                            `value: ${cims.length} cims cargados. Usa los controles para ajustar.; color: green; align: center; width: 3;`
                        );
                    }
                },
                error => {
                    log(`Error obteniendo posición: ${error.message}`);
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }
        
        // Cargar cims desde localStorage
        try {
            const cimsData = localStorage.getItem('ar-cims');
            if (cimsData) {
                cims = JSON.parse(cimsData);
                log(`Cargados ${cims.length} cims desde localStorage`);
            } else {
                log('No se encontraron datos de cims en localStorage');
                
                // Cargar cims de ejemplo si no hay datos en localStorage
                cims = [
                    {
                        "id": 1,
                        "nom": "Santa Brígida",
                        "latitude": 42.0284,
                        "longitude": 2.6166,
                        "altitud": 464,
                        "localització": "Amer, La Selva",
                        "descripció": "Santa Brígida és una muntanya emblemàtica del poble d'Amer, amb bones vistes i una ermita al cim."
                    },
                    {
                        "id": 2,
                        "nom": "Puigsacalm",
                        "latitude": 42.1019,
                        "longitude": 2.4606,
                        "altitud": 1515,
                        "localització": "Vall d'en Bas, Garrotxa",
                        "descripció": "El Puigsacalm és un dels cims més emblemàtics de la Garrotxa, amb vistes panoràmiques excepcionals."
                    },
                    {
                        "id": 3,
                        "nom": "Canigó",
                        "latitude": 42.5186,
                        "longitude": 2.4558,
                        "altitud": 2784,
                        "localització": "Catalunya Nord",
                        "descripció": "El Canigó és una muntanya mítica de la cultura catalana."
                    },
                    {
                        "id": 4,
                        "nom": "Pedraforca",
                        "latitude": 42.2397,
                        "longitude": 1.7062,
                        "altitud": 2506,
                        "localització": "Berguedà",
                        "descripció": "El Pedraforca és una de les muntanyes més emblemàtiques de Catalunya."
                    }
                ];
                log('Cargados cims de ejemplo');
            }
        } catch (error) {
            log(`Error al cargar cims: ${error.message}`);
        }
        
        // Verificar permisos de geolocalización
        if ('geolocation' in navigator) {
            log('Geolocalización disponible');
            
            // Solicitar permisos de geolocalización
            navigator.geolocation.getCurrentPosition(
                position => {
                    log(`Posición obtenida: ${position.coords.latitude}, ${position.coords.longitude} (precisión: ${position.coords.accuracy}m)`);
                    
                    // Actualizar mensaje de estado
                    const statusEl = document.getElementById('status-message');
                    if (statusEl) {
                        statusEl.setAttribute(
                            'text',
                            `value: Lat: ${position.coords.latitude.toFixed(6)}, Lon: ${position.coords.longitude.toFixed(6)}; color: white; align: center; width: 3;`
                        );
                    }
                    
                    // Crear entidades para los cims
                    if (!entitiesCreated) {
                        createEntities();
                    }
                },
                error => {
                    log(`Error de geolocalización: ${error.message} (código: ${error.code})`);
                    
                    // Actualizar mensaje de instrucciones
                    const instructionEl = document.getElementById('instruction-message');
                    if (instructionEl) {
                        instructionEl.setAttribute(
                            'text',
                            `value: Error de geolocalización: ${error.message}; color: red; align: center; width: 3;`
                        );
                    }
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
            
            // Monitorear cambios en la posición
            const watchId = navigator.geolocation.watchPosition(
                position => {
                    const statusEl = document.getElementById('status-message');
                    if (statusEl) {
                        statusEl.setAttribute(
                            'text',
                            `value: Lat: ${position.coords.latitude.toFixed(6)}, Lon: ${position.coords.longitude.toFixed(6)}, Precisión: ${position.coords.accuracy.toFixed(2)}m; color: white; align: center; width: 3;`
                        );
                    }
                    
                    log(`Posición actualizada: ${position.coords.latitude}, ${position.coords.longitude} (precisión: ${position.coords.accuracy}m)`);
                    
                    // Crear entidades si aún no se han creado
                    if (!entitiesCreated) {
                        createEntities();
                    }
                    
                    // Actualizar distancias a los cims
                    cims.forEach(cim => {
                        // Calcular distancia aproximada
                        const R = 6371; // Radio de la Tierra en km
                        const dLat = (cim.latitude - position.coords.latitude) * Math.PI / 180;
                        const dLon = (cim.longitude - position.coords.longitude) * Math.PI / 180;
                        const a = 
                            Math.sin(dLat/2) * Math.sin(dLat/2) +
                            Math.cos(position.coords.latitude * Math.PI / 180) * Math.cos(cim.latitude * Math.PI / 180) * 
                            Math.sin(dLon/2) * Math.sin(dLon/2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                        const distance = R * c;
                        
                        // Actualizar texto de distancia
                        const entity = document.getElementById(`cim-${cim.id}`);
                        if (entity) {
                            const distTexts = entity.querySelectorAll('a-text');
                            if (distTexts.length >= 3) {
                                distTexts[2].setAttribute('value', `${distance.toFixed(1)} km`);
                            }
                        }
                    });
                },
                error => {
                    log(`Error en watchPosition: ${error.message}`);
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        } else {
            log('Geolocalización NO disponible en este dispositivo/navegador');
            
            // Actualizar mensaje de instrucciones
            const instructionEl = document.getElementById('instruction-message');
            if (instructionEl) {
                instructionEl.setAttribute(
                    'text',
                    `value: Geolocalización no disponible en este dispositivo.; color: red; align: center; width: 3;`
                );
            }
        }
        
        // Ocultar el loader cuando la escena esté lista
        document.querySelector('a-scene').addEventListener('loaded', () => {
            log('Escena AR cargada');
            loader.style.display = 'none';
            
            // Crear entidades después de que la escena esté cargada
            setTimeout(() => {
                if (!entitiesCreated) {
                    log('Creando entidades después de cargar la escena...');
                    createEntities();
                }
            }, 2000);
        });
        
        // Monitorear eventos de AR.js
        document.addEventListener('gps-camera-update-position', e => {
            const { latitude, longitude, accuracy } = e.detail.position;
            log(`AR.js posición actualizada: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (precisión: ${accuracy.toFixed(2)}m)`);
            
            // Crear entidades si aún no se han creado
            if (!entitiesCreated) {
                createEntities();
            }
        });
        
        // Manejar eventos de permisos de cámara
        document.addEventListener('camera-init', () => {
            log('Cámara inicializada');
        });
        
        document.addEventListener('camera-error', (error) => {
            log(`Error de cámara: ${error}`);
        });
        
        // Recrear entidades cuando se da permiso a la cámara
        document.addEventListener('camera-started', () => {
            log('Cámara iniciada - recreando entidades');
            setTimeout(() => {
                if (!entitiesCreated) {
                    createEntities();
                }
            }, 1000);
        });
    </script>
</body>
</html>

