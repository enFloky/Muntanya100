<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR GPS - Muntanya100</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .arjs-loader div {
            text-align: center;
            font-size: 1.25em;
            color: white;
        }
        #exit-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 10px 15px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            z-index: 9999;
            max-height: 30vh;
            overflow-y: auto;
        }
        /* Añadir botones para ajustar la escala */
        #control-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 9999;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
        .control-button {
            margin: 5px;
            padding: 5px 10px;
            background-color: rgba(255,255,255,0.3);
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
        }
        /* Añadir selector de modo */
        #mode-selector {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
        /* Mensaje de error */
        #error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 10000;
            max-width: 80%;
            text-align: center;
            display: none;
        }
        /* Botón de reintentar */
        #retry-button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: white;
            color: black;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <div class="arjs-loader">
        <div>Cargando experiencia AR con GPS, por favor espera...</div>
    </div>
    
    <button id="exit-button" onclick="window.location.href='/Muntanya100/'">❌ Sortir</button>
    
    <div id="control-panel">
        <div>Ajustar marcadores:</div>
        <button class="control-button" onclick="adjustScale(2)">+ Tamaño</button>
        <button class="control-button" onclick="adjustScale(0.5)">- Tamaño</button>
        <button class="control-button" onclick="adjustHeight(500)">+ Altura</button>
        <button class="control-button" onclick="adjustHeight(-500)">- Altura</button>
        <button class="control-button" onclick="toggleVisibility()">Mostrar/Ocultar</button>
        <button class="control-button" onclick="recreateEntities()">Recrear Marcadores</button>
    </div>
    
    <div id="mode-selector">
        <div>Modo:</div>
        <button class="control-button" onclick="switchToLocationMode()">Ubicación Real</button>
        <button class="control-button" onclick="switchToDirectionMode()">Dirección Visual</button>
    </div>
    
    <div id="debug-panel">Iniciando AR con GPS...</div>
    
    <div id="error-message">
        <div>Error al iniciar la experiencia AR</div>
        <div id="error-details">Detalles del error</div>
        <button id="retry-button" onclick="retryInitialization()">Reintentar</button>
    </div>
    
    <a-scene
        embedded
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; antialias: true;"
        loading-screen="enabled: false">
        
        <a-camera id="camera" position="0 1.6 0" look-controls="pointerLockEnabled: false">
            <!-- Mensaje de estado -->
            <a-entity 
                text="value: Buscando posición GPS...; color: white; align: center; width: 3;"
                position="0 -0.5 -1"
                id="status-message">
            </a-entity>
            
            <!-- Mensaje de instrucciones -->
            <a-entity 
                text="value: Buscando cims cercanos...; color: yellow; align: center; width: 3;"
                position="0 0.5 -1"
                id="instruction-message">
            </a-entity>
        </a-camera>
        
        <!-- Contenedor para los marcadores -->
        <a-entity id="markers-container"></a-entity>
    </a-scene>
    
    <script>
        const debugPanel = document.getElementById('debug-panel');
        const loader = document.querySelector('.arjs-loader');
        const markersContainer = document.getElementById('markers-container');
        const errorMessage = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        let currentScale = 1;
        let currentHeight = 0;
        let entitiesVisible = true;
        let cims = [];
        let entitiesCreated = false;
        let currentMode = 'direction'; // Cambiado a 'direction' por defecto para evitar problemas de GPS
        let userPosition = null;
        let initializationTimeout;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugPanel.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugPanel.scrollTop = debugPanel.scrollHeight;
            console.log(`[${timestamp}] ${message}`); // También log a la consola para depuración
        }
        
        function showError(message) {
            errorDetails.textContent = message;
            errorMessage.style.display = 'block';
            loader.style.display = 'none';
            log(`ERROR: ${message}`);
        }
        
        function retryInitialization() {
            errorMessage.style.display = 'none';
            loader.style.display = 'flex';
            log('Reintentando inicialización...');
            
            // Limpiar cualquier timeout existente
            if (initializationTimeout) {
                clearTimeout(initializationTimeout);
            }
            
            // Reiniciar la inicialización
            setTimeout(() => {
                initializeAR();
            }, 1000);
        }
        
        // Función para ajustar la escala de todos los marcadores
        function adjustScale(factor) {
            currentScale *= factor;
            log(`Ajustando escala a: ${currentScale.toFixed(2)}`);
            
            document.querySelectorAll('.marker-entity').forEach(entity => {
                const currentScale = entity.getAttribute('scale').split(' ').map(parseFloat);
                entity.setAttribute('scale', `${currentScale[0] * factor} ${currentScale[1] * factor} ${currentScale[2] * factor}`);
            });
        }
        
        // Función para ajustar la altura de todos los marcadores
        function adjustHeight(delta) {
            currentHeight += delta;
            log(`Ajustando altura a: ${currentHeight}`);
            
            document.querySelectorAll('.marker-entity').forEach(entity => {
                const currentPosition = entity.getAttribute('position').split(' ').map(parseFloat);
                entity.setAttribute('position', `${currentPosition[0]} ${currentPosition[1] + delta} ${currentPosition[2]}`);
            });
        }
        
        // Función para mostrar/ocultar marcadores
        function toggleVisibility() {
            entitiesVisible = !entitiesVisible;
            log(`Marcadores ${entitiesVisible ? 'visibles' : 'ocultos'}`);
            
            document.querySelectorAll('.marker-entity').forEach(entity => {
                entity.setAttribute('visible', entitiesVisible);
            });
        }
        
        // Función para recrear entidades
        function recreateEntities() {
            log('Recreando marcadores...');
            
            // Eliminar entidades existentes
            while (markersContainer.firstChild) {
                markersContainer.removeChild(markersContainer.firstChild);
            }
            
            // Recrear entidades
            if (currentMode === 'location') {
                createLocationBasedEntities();
            } else {
                createDirectionBasedEntities();
            }
        }
        
        // Cambiar al modo de ubicación real
        function switchToLocationMode() {
            if (currentMode !== 'location') {
                currentMode = 'location';
                log('Cambiando a modo de ubicación real');
                recreateEntities();
            }
        }
        
        // Cambiar al modo de dirección visual
        function switchToDirectionMode() {
            if (currentMode !== 'direction') {
                currentMode = 'direction';
                log('Cambiando a modo de dirección visual');
                recreateEntities();
            }
        }
        
        // Función para crear entidades basadas en ubicación GPS
        function createLocationBasedEntities() {
            if (cims.length === 0) {
                log('No hay cims para mostrar');
                return;
            }
            
            if (!userPosition) {
                log('Posición de usuario no disponible, usando modo de dirección visual');
                createDirectionBasedEntities();
                return;
            }
            
            log(`Creando ${cims.length} marcadores basados en ubicación...`);
            
            cims.forEach(cim => {
                log(`Creando entidad para ${cim.nom} en ${cim.latitude}, ${cim.longitude}`);
                
                // Calcular distancia aproximada
                const R = 6371; // Radio de la Tierra en km
                const dLat = (cim.latitude - userPosition.latitude) * Math.PI / 180;
                const dLon = (cim.longitude - userPosition.longitude) * Math.PI / 180;
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(userPosition.latitude * Math.PI / 180) * Math.cos(cim.latitude * Math.PI / 180) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                const distance = R * c;
                
                log(`Distancia a ${cim.nom}: ${distance.toFixed(2)} km`);
                
                // Calcular dirección (bearing) desde la posición del usuario hasta el cim
                const yBearing = Math.sin(dLon) * Math.cos(cim.latitude * Math.PI / 180);
                const xBearing = Math.cos(userPosition.latitude * Math.PI / 180) * Math.sin(cim.latitude * Math.PI / 180) -
                          Math.sin(userPosition.latitude * Math.PI / 180) * Math.cos(cim.latitude * Math.PI / 180) * Math.cos(dLon);
                const bearing = Math.atan2(yBearing, xBearing) * 180 / Math.PI;
                const bearingNormalized = (bearing + 360) % 360;
                
                log(`Dirección a ${cim.nom}: ${bearingNormalized.toFixed(2)}°`);
                
                // Crear entidad para el marcador
                const entity = document.createElement('a-entity');
                entity.setAttribute('class', 'marker-entity');
                entity.setAttribute('id', `cim-${cim.id}`);
                entity.setAttribute('data-name', cim.nom);
                entity.setAttribute('data-distance', distance.toFixed(1));
                entity.setAttribute('data-altitude', cim.altitud);
                entity.setAttribute('data-bearing', bearingNormalized.toFixed(1));
                
                // Posicionar el marcador en la dirección correcta
                // Convertir bearing a radianes
                const bearingRad = bearingNormalized * Math.PI / 180;
                
                // Calcular posición en coordenadas cartesianas
                // Usamos una distancia visual fija para todos los marcadores (ajustada por la distancia real)
                const visualDistance = Math.min(100, 20 + 80 * Math.min(1, distance / 50));
                const x = -Math.sin(bearingRad) * visualDistance;
                const z = -Math.cos(bearingRad) * visualDistance;
                const y = 0; // Altura base
                
                entity.setAttribute('position', `${x} ${y} ${z}`);
                
                entity.setAttribute('scale', '1 1 1');
                
                // Añadir marcador visible (esfera)
                const marker = document.createElement('a-sphere');
                marker.setAttribute('radius', '2');
                marker.setAttribute('color', 'red');
                marker.setAttribute('opacity', '0.8');
                marker.setAttribute('position', '0 0 0');
                marker.setAttribute('emissive', 'red');
                marker.setAttribute('emissiveIntensity', '0.5');
                entity.appendChild(marker);
                
                // Añadir cilindro para conectar con el texto
                const cylinder = document.createElement('a-cylinder');
                cylinder.setAttribute('radius', '0.5');
                cylinder.setAttribute('height', '5');
                cylinder.setAttribute('color', 'yellow');
                cylinder.setAttribute('opacity', '0.5');
                cylinder.setAttribute('position', '0 2.5 0');
                entity.appendChild(cylinder);
                
                // Añadir texto con el nombre
                const text = document.createElement('a-text');
                text.setAttribute('value', cim.nom);
                text.setAttribute('align', 'center');
                text.setAttribute('color', 'white');
                text.setAttribute('position', '0 6 0');
                text.setAttribute('scale', '2 2 2');
                text.setAttribute('look-at', '#camera');
                entity.appendChild(text);
                
                // Añadir texto con altitud
                const altText = document.createElement('a-text');
                altText.setAttribute('value', `${cim.altitud}m`);
                altText.setAttribute('align', 'center');
                altText.setAttribute('color', 'yellow');
                altText.setAttribute('position', '0 5 0');
                altText.setAttribute('scale', '1.5 1.5 1.5');
                altText.setAttribute('look-at', '#camera');
                entity.appendChild(altText);
                
                // Añadir texto con distancia
                const distText = document.createElement('a-text');
                distText.setAttribute('value', `${distance.toFixed(1)} km`);
                distText.setAttribute('align', 'center');
                distText.setAttribute('color', 'lightgreen');
                distText.setAttribute('position', '0 4 0');
                distText.setAttribute('scale', '1.5 1.5 1.5');
                distText.setAttribute('look-at', '#camera');
                entity.appendChild(distText);
                
                // Añadir la entidad al contenedor
                markersContainer.appendChild(entity);
            });
            
            entitiesCreated = true;
            
            // Actualizar mensaje de instrucciones
            const instructionEl = document.getElementById('instruction-message');
            if (instructionEl) {
                instructionEl.setAttribute(
                    'text',
                    `value: ${cims.length} cims cargados. Usa los controles para ajustar.; color: green; align: center; width: 3;`
                );
            }
        }
        
        // Función para crear entidades basadas en dirección visual
        function createDirectionBasedEntities() {
            if (cims.length === 0) {
                log('No hay cims disponibles para crear marcadores');
                return;
            }
            
            log(`Creando ${cims.length} marcadores basados en dirección visual...`);
            cims.forEach((cim, index) => {
                log(`Intentando crear marcador para: ${cim.nom}`);
                // ...resto del código...
            });
        }
        
        // Inicializar la experiencia AR
        function initializeAR() {
            log('Inicializando experiencia AR...');
            
            // Establecer un timeout para detectar si la inicialización se queda colgada
            initializationTimeout = setTimeout(() => {
                if (!entitiesCreated) {
                    showError('La inicialización está tardando demasiado. Intenta cambiar al modo de demostración.');
                }
            }, 15000); // 15 segundos
            
            // Cargar cims desde localStorage
            try {
                const cimsData = localStorage.getItem('ar-cims');
                if (cimsData) {
                    cims = JSON.parse(cimsData);
                    log(`Cargados ${cims.length} cims desde localStorage`);
                } else {
                    log('No se encontraron datos de cims en localStorage');
                    
                    // Cargar cims de ejemplo si no hay datos en localStorage
                    cims = [
                        {
                            "id": 1,
                            "nom": "Santa Brígida",
                            "latitude": 42.0284,
                            "longitude": 2.6166,
                            "altitud": 464,
                            "localització": "Amer, La Selva",
                            "descripció": "Santa Brígida és una muntanya emblemàtica del poble d'Amer, amb bones vistes i una ermita al cim."
                        },
                        {
                            "id": 2,
                            "nom": "Puigsacalm",
                            "latitude": 42.1019,
                            "longitude": 2.4606,
                            "altitud": 1515,
                            "localització": "Vall d'en Bas, Garrotxa",
                            "descripció": "El Puigsacalm és un dels cims més emblemàtics de la Garrotxa, amb vistes panoràmiques excepcionals."
                        },
                        {
                            "id": 3,
                            "nom": "Canigó",
                            "latitude": 42.5186,
                            "longitude": 2.4558,
                            "altitud": 2784,
                            "localització": "Catalunya Nord",
                            "descripció": "El Canigó és una muntanya mítica de la cultura catalana."
                        },
                        {
                            "id": 4,
                            "nom": "Pedraforca",
                            "latitude": 42.2397,
                            "longitude": 1.7062,
                            "altitud": 2506,
                            "localització": "Berguedà",
                            "descripció": "El Pedraforca és una de les muntanyes més emblemàtiques de Catalunya."
                        }
                    ];
                    log('Cargados cims de ejemplo');
                }
                // Añade esto después de cargar los cims
                log('Datos de cims cargados:', JSON.stringify(cims));
                
                // Verificar el modo seleccionado en localStorage
                const savedMode = localStorage.getItem('ar-mode');
                if (savedMode && (savedMode === 'location' || savedMode === 'direction')) {
                    currentMode = savedMode;
                    log(`Modo cargado desde localStorage: ${currentMode}`);
                }
            } catch (error) {
                log(`Error al cargar cims: ${error.message}`);
                showError(`Error al cargar datos: ${error.message}`);
            }
            
            // Crear entidades inmediatamente en modo dirección visual para mostrar algo
            if (currentMode === 'direction') {
                createDirectionBasedEntities();
            }
            
            // Verificar permisos de geolocalización
            if ('geolocation' in navigator) {
                log('Geolocalización disponible');
                
                // Solicitar permisos de geolocalización
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userPosition = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        
                        log(`Posición obtenida: ${userPosition.latitude}, ${userPosition.longitude} (precisión: ${userPosition.accuracy}m)`);
                        
                        // Actualizar mensaje de estado
                        const statusEl = document.getElementById('status-message');
                        if (statusEl) {
                            statusEl.setAttribute(
                                'text',
                                `value: Lat: ${userPosition.latitude.toFixed(6)}, Lon: ${userPosition.longitude.toFixed(6)}; color: white; align: center; width: 3;`
                            );
                        }
                        
                        // Crear entidades para los cims si estamos en modo ubicación
                        if (currentMode === 'location' && !entitiesCreated) {
                            createLocationBasedEntities();
                        }
                    },
                    error => {
                        log(`Error de geolocalización: ${error.message} (código: ${error.code})`);
                        
                        // Actualizar mensaje de instrucciones
                        const instructionEl = document.getElementById('instruction-message');
                        if (instructionEl) {
                            instructionEl.setAttribute(
                                'text',
                                `value: Error de geolocalización: ${error.message}; color: red; align: center; width: 3;`
                            );
                        }
                        
                        // Cambiar a modo dirección visual si hay error de geolocalización
                        if (currentMode === 'location') {
                            log('Cambiando a modo dirección visual debido a error de geolocalización');
                            currentMode = 'direction';
                            if (!entitiesCreated) {
                                createDirectionBasedEntities();
                            }
                        }
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
                
                // Monitorear cambios en la posición
                const watchId = navigator.geolocation.watchPosition(
                    position => {
                        userPosition = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        
                        const statusEl = document.getElementById('status-message');
                        if (statusEl) {
                            statusEl.setAttribute(
                                'text',
                                `value: Lat: ${userPosition.latitude.toFixed(6)}, Lon: ${userPosition.longitude.toFixed(6)}, Precisión: ${userPosition.accuracy.toFixed(2)}m; color: white; align: center; width: 3;`
                            );
                        }
                        
                        log(`Posición actualizada: ${userPosition.latitude}, ${userPosition.longitude} (precisión: ${userPosition.accuracy}m)`);
                        
                        // Crear entidades si aún no se han creado y estamos en modo ubicación
                        if (currentMode === 'location' && !entitiesCreated) {
                            createLocationBasedEntities();
                        }
                        
                        // Actualizar distancias a los cims si estamos en modo dirección visual
                        if (currentMode === 'direction' && entitiesCreated) {
                            cims.forEach(cim => {
                                // Calcular distancia aproximada
                                const R = 6371; // Radio de la Tierra en km
                                const dLat = (cim.latitude - userPosition.latitude) * Math.PI / 180;
                                const dLon = (cim.longitude - userPosition.longitude) * Math.PI / 180;
                                const a = 
                                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                                    Math.cos(userPosition.latitude * Math.PI / 180) * Math.cos(cim.latitude * Math.PI / 180) * 
                                    Math.sin(dLon/2) * Math.sin(dLon/2);
                                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                                const distance = R * c;
                                
                                // Actualizar texto de distancia
                                const entity = document.getElementById(`cim-${cim.id}`);
                                if (entity) {
                                    const distTexts = entity.querySelectorAll('a-text');
                                    if (distTexts.length >= 3) {
                                        distTexts[2].setAttribute('value', `${distance.toFixed(1)} km`);
                                    }
                                }
                            });
                        }
                    },
                    error => {
                        log(`Error en watchPosition: ${error.message}`);
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            } else {
                log('Geolocalización NO disponible en este dispositivo/navegador');
                
                // Actualizar mensaje de instrucciones
                const instructionEl = document.getElementById('instruction-message');
                if (instructionEl) {
                    instructionEl.setAttribute(
                        'text',
                        `value: Geolocalización no disponible en este dispositivo.; color: red; align: center; width: 3;`
                    );
                }
                
                // Crear entidades en modo dirección visual si no hay geolocalización
                currentMode = 'direction';
                if (!entitiesCreated) {
                    createDirectionBasedEntities();
                }
            }
        }
        
        // Ocultar el loader cuando la escena esté lista
        document.querySelector('a-scene').addEventListener('loaded', () => {
            log('Escena AR cargada');
            loader.style.display = 'none';
            
            // Limpiar el timeout de inicialización
            if (initializationTimeout) {
                clearTimeout(initializationTimeout);
            }
            
            // Crear entidades después de que la escena esté cargada si aún no se han creado
            setTimeout(() => {
                if (!entitiesCreated) {
                    log('Creando entidades después de cargar la escena...');
                    if (currentMode === 'location' && userPosition) {
                        createLocationBasedEntities();
                    } else {
                        currentMode = 'direction';
                        createDirectionBasedEntities();
                    }
                    entitiesCreated = true; // Set flag to true after creating entities
                }
            }, 2000);
        });
        
        // Manejar eventos de permisos de cámara
        document.addEventListener('camera-init', () => {
            log('Cámara inicializada');
        });
        
        document.addEventListener('camera-error', (error) => {
            log(`Error de cámara: ${error}`);
            showError(`Error de cámara: ${error}`);
        });
        
        // Recrear entidades cuando se da permiso a la cámara
        document.addEventListener('camera-started', () => {
            log('Cámara iniciada - recreando entidades');
            setTimeout(() => {
                if (!entitiesCreated) {
                    if (currentMode === 'location' && userPosition) {
                        createLocationBasedEntities();
                    } else {
                        currentMode = 'direction';
                        createDirectionBasedEntities();
                    }
                    entitiesCreated = true; // Set flag to true after creating entities
                }
            }, 1000);
        });
        
        // Iniciar la experiencia AR
        window.addEventListener('load', () => {
            log('Página cargada, iniciando AR...');
            log('Modo actual:', currentMode);
            log('Entidades creadas:', entitiesCreated);
            initializeAR();
        });

        const positions = [
            { x: 0, y: 0, z: -10 },  // Más cerca
            { x: 10, y: 0, z: -10 }, // Más cerca y a la derecha
            { x: -10, y: 0, z: -10 }, // Más cerca y a la izquierda
            { x: 0, y: 5, z: -15 }   // Más cerca y arriba
        ];
    </script>
</body>
</html>

